{% extends "base.html" %}

{% load wagtailcore_tags %}
{% load tz %}
{% block body_class %}template-dashboard{% endblock %}

{% block content %}
    <main class="">
        <div class="border-b border-primary-500 p-4">
            <nav class="flex items-center justify-between flex-wrap">
                <div class="flex items-center flex-shrink-0 mr-6">
                    <span class="font-bold text-xl leading-normal">{{ page.title }}</span>
                </div>
            </nav>
        </div>
        <section class="w-[80%] p-4">
            <span class="mb-3 font-semibold text-base leading-normal">{{ page.intro|richtext }}</span>
            <div id="mentor_session" class="flex m-2 border border-gray-300 text-sm leading-4 text-gray-900 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <div class="min-w-[128px] max-w-[128px] max-h-8 py-1.5 px-3 rounded-l-lg">Date</div>
                <div class="min-w-[640px] max-w-[640px] max-h-8 py-1.5 px-3">Header 2</div>
                <div class="min-w-[48px] max-w-[48px] max-h-8 py-1.5 px-3 rounded-r-lg"></div>
            </div>
            {% for item in mentor_session %}
                <div class="flex m-2 border border-gray-300 text-sm leading-4 text-gray-900 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <div class="min-w-[128px] max-w-[128px] max-h-12 py-1.5 px-3 rounded-l-lg"
                         x-data
                         x-init="setTimeout(() => $refs.span.innerText = new Date({{ item.create_date }} * 1000).toLocaleString())">
                        <span x-ref="span"></span>
                    </div>
                    <div class="min-w-[640px] max-w-[640px] max-h-12 py-1.5 px-3 overflow-hidden whitespace-no-wrap text-overflow ellipsis">{{ item.runnable_output|safe|truncatechars:140 }}</div>
                    <div class="min-w-[48px] max-w-[48px] max-h-12 py-1.5 px-3 rounded-r-lg"><a href="{{ item.mentor_url }}"
                                                                             class="no-underline">Edit</a></div>
                </div>
            {% endfor %}

            </div>
            <button id="previousButton" class="hidden" hx-on:htmx:before-request="previousPageRequest()" hx-get="/"
                    hx-target="#mentor_session" hx-select="#mentor_session"
                    hx-vals='js:{"exclusive_start_key": previousKeyStack.pop()}'>Previous
            </button>
            <button hx-on:htmx:before-request="nextPageRequest()" hx-get="/" hx-target="#mentor_session"
                    hx-select="#mentor_session" hx-vals='js:{"exclusive_start_key": lastKey}'>Next
            </button>

        </section>
    </main>

{% endblock %}
{% block extra_body %}
    <script>
        var previousButton = document.getElementById("previousButton");

        let previousKeyStack = [];
        let previousKey = null;
        let lastKey = "{{ last_evaluated_key }}";

        function previousPageRequest() {
            console.log(previousKeyStack.length)
            if (previousKeyStack.length === 0)
                previousButton.style.display = "none";
        }

        function nextPageRequest() {
            previousButton.style.display = "block";
            console.log("in nextPageRequest");
            console.log(previousKey);
            previousKeyStack.push(previousKey);
            previousKey = lastKey;
        }

        // This function will be called by htmx after every request
        document.body.addEventListener('htmx:afterOnLoad', function (event) {
            let xhr = event.detail.xhr;
            lastKey = xhr.getResponseHeader("X-Last-Evaluated-Key");
            console.log(lastKey)
        });

    </script>
{% endblock %}